<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluesky Client</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h2>Bluesky Client</h2>

        <div class="mode-switch">
            <label for="toggle" class="switch">
                <input type="checkbox" id="toggle" onchange="toggleMode()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required>
        </div>

        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>

        <button onclick="loginAndFetchPosts()">Login</button>

        <h3>Your Posts:</h3>
        <div id="posts"></div>
    </div>

    <script>
        const apiUrl = "https://bsky.social/xrpc";

        async function loginAndFetchPosts() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            // Step 1: Create a session with the user's credentials
            const loginResponse = await fetch(`${apiUrl}/com.atproto.server.createSession`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ identifier: username, password: password })
            });

            if (!loginResponse.ok) {
                const errorData = await loginResponse.json();
                alert("Login failed: " + errorData.message);
                return;
            }

            const loginData = await loginResponse.json();

            // Step 2: Fetch user's posts using the access token
            const postsResponse = await fetch(`${apiUrl}/com.atproto.repo.listRecords?repo=${loginData.did}&collection=app.bsky.feed.post`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${loginData.accessJwt}`
                }
            });

            if (!postsResponse.ok) {
                const errorData = await postsResponse.json();
                alert('Failed to fetch posts: ' + errorData.message);
                return;
            }

            const postsData = await postsResponse.json();
            console.log(postsData);  // Log posts data for debugging
            displayPosts(postsData, username);
        }

        function displayPosts(data, username) {
            const postsContainer = document.getElementById("posts");
            postsContainer.innerHTML = ''; // Clear existing posts

            if (!data.records || data.records.length === 0) {
                postsContainer.innerHTML = "<p>No posts found.</p>";
                return;
            }

            data.records.forEach(async (post) => {
                const postElement = document.createElement('div');
                postElement.className = 'post';

                // Using the provided username for the author
                const authorHandle = username; // Use the authenticated username
                const postText = post.value?.text || 'No content available.';
                const createdAt = post.value?.createdAt ? new Date(post.value.createdAt).toLocaleString() : 'Unknown Date';

                // Generate the post URL based on the username and post ID
                const postId = post.uri.split('/').pop(); // Extract post ID from URI
                const postUrl = `https://bsky.app/profile/${authorHandle}/post/${postId}`;

                // Render post
                postElement.innerHTML = `
                    <h4><a href="${postUrl}" target="_blank">${authorHandle}</a></h4>
                    <p>${postText}</p>
                    <p><strong>Created At:</strong> ${createdAt}</p>
                `;
                postsContainer.appendChild(postElement);
            });
        }

        function toggleMode() {
            const body = document.body;
            const toggle = document.getElementById('toggle');

            body.classList.toggle('dark-mode', toggle.checked);
            body.classList.toggle('light-mode', !toggle.checked);
        }
    </script>
</body>
</html>
