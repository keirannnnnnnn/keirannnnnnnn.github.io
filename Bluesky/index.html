<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluesky Client</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212; /* Dark background */
            color: #E0E0E0; /* Light grey text */
        }

        .container {
            padding: 20px;
            max-width: 480px; /* Restricting max width for better mobile view */
            margin: auto; /* Center the container */
            background: #1E1E1E; /* Slightly lighter dark background */
            border-radius: 16px; /* More rounded corners */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); /* Softer shadow */
        }

        h2, h3 {
            text-align: center;
            color: #FFFFFF; /* White text for headings */
        }

        #tabSystem {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        #tabSystem button {
            flex: 1; /* Make buttons flexible to fill the available space */
            padding: 10px;
            background: transparent; /* Transparent background for buttons */
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #A8A8A8; /* Light grey for non-active tabs */
            position: relative;
            border-radius: 12px; /* Rounded corners for buttons */
            transition: color 0.3s, background 0.3s; /* Smooth transition for hover effect */
        }

        #tabSystem button:hover {
            color: #FFFFFF; /* Highlight on hover */
            background: rgba(255, 255, 255, 0.1); /* Light background on hover for buttons */
        }

        #tabSystem button.active {
            color: #007AFF; /* Active tab color similar to macOS */
        }

        #tabSystem button.active::after {
            content: '';
            display: block;
            height: 2px;
            background: #007AFF; /* Blue line under active tab */
            position: absolute;
            left: 0;
            right: 0;
            bottom: -5px; /* Position below the button */
        }

        #tabSystem button:not(.active) {
            color: #A8A8A8; /* Light grey color for non-active tabs */
        }

        .post {
            margin: 10px 0;
            padding: 10px;
            background-color: #2C2C2C; /* Darker background for posts */
            border-radius: 12px; /* Rounded corners for posts */
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5); /* Softer shadow */
        }

        .post h4 {
            margin: 0 0 5px 0;
            font-size: 1.1em; /* Slightly larger font for post title */
            color: #FFFFFF; /* White text for post titles */
        }

        .post p {
            margin: 5px 0;
            font-size: 0.9em; /* Smaller font for post content */
            color: #B0B0B0; /* Grey for post content */
        }

        .login-message {
            margin-bottom: 20px;
            color: #FFFFFF; /* White for login messages */
            text-align: center;
        }

        @media (max-width: 768px) {
            #tabSystem button {
                font-size: 0.9em; /* Adjust button font size for smaller screens */
            }
        }
    </style>
</head>
<body>
    <script>
        // Redirect to mobile site if on mobile
        if (window.innerWidth <= 768) {
            window.location.href = "https://glos-omu.uk/Bluesky/mobile";
        }
    </script>

    <div class="container">
        <h2>Bluesky Client</h2>

        <h3 id="userPostsHeader">User Posts:</h3>
        <div id="tabSystem">
            <button id="allPostsTab" class="active" onclick="filterPosts('all')">All Posts</button>
            <button id="timPostsTab" onclick="filterPosts('tim')">tim.glos-omu.uk</button>
            <button id="keiranPostsTab" onclick="filterPosts('keiran')">keirannnnnnnn.glos-omu.uk</button>
        </div>
        <div id="posts"></div>
    </div>

    <script>
        const apiUrl = "https://bsky.social/xrpc";
        const targetUsers = {
            "tim.glos-omu.uk": "tim.glos-omu.uk",
            "keirannnnnnnn.glos-omu.uk": "keirannnnnnnn.glos-omu.uk"
        };
        let allPosts = []; // Store all fetched posts for filtering

        async function fetchPosts() {
            // Step 1: Fetch posts from target users
            const postsData = await Promise.all(Object.keys(targetUsers).map(user => fetchUserPosts(user)));
            allPosts = postsData.flat(); // Flatten the array of posts
            displayPosts(allPosts);
        }

        async function fetchUserPosts(user) {
            const response = await fetch(`${apiUrl}/com.atproto.repo.listRecords?repo=${user}&collection=app.bsky.feed.post`, {
                method: "GET",
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(`Failed to fetch posts for ${user}: ${errorData.message}`);
                return [];
            }

            const posts = await response.json();
            // Add username directly to each post
            return (posts.records || []).map(post => ({
                ...post,
                username: targetUsers[user] // Add username based on the user who posted
            }));
        }

        function displayPosts(posts) {
            const postsContainer = document.getElementById("posts");
            postsContainer.innerHTML = ''; // Clear existing posts

            if (!posts || posts.length === 0) {
                postsContainer.innerHTML = "<p>No posts found.</p>";
                return;
            }

            posts.forEach((post) => {
                const postElement = document.createElement('div');
                postElement.className = 'post';
                const postText = post.value?.text || 'No content available.';
                const createdAt = post.value?.createdAt ? new Date(post.value.createdAt).toLocaleString() : 'Unknown Date';

                // Generate the post URL based on the username and post ID
                const postId = post.uri.split('/').pop(); // Extract post ID from URI
                const postUrl = `https://bsky.app/profile/${post.username}/post/${postId}`;

                // Make the entire post box clickable to navigate to the post URL
                postElement.innerHTML = `
                    <h4><a href="${postUrl}" target="_blank" style="color: #007AFF;">${post.username}</a></h4>
                    <p>${postText}</p>
                    <p><strong>Created At:</strong> ${createdAt}</p>
                `;
                postElement.onclick = () => window.open(postUrl, '_blank'); // Open post on click
                postsContainer.appendChild(postElement);
            });
        }

        function filterPosts(user) {
            let filteredPosts;

            if (user === 'all') {
                filteredPosts = allPosts; // Show all posts
                setActiveTab('allPostsTab');
            } else {
                const selectedUser = user === 'tim' ? "tim.glos-omu.uk" : "keirannnnnnnn.glos-omu.uk";
                filteredPosts = allPosts.filter(post => post.username === selectedUser); // Filter for selected user
                setActiveTab(user === 'tim' ? 'timPostsTab' : 'keiranPostsTab');
            }

            displayPosts(filteredPosts); // Display the filtered posts
        }

        function setActiveTab(activeTabId) {
            const tabs = document.querySelectorAll("#tabSystem button");
            tabs.forEach(tab => {
                tab.classList.remove("active"); // Remove active class from all tabs
            });
            document.getElementById(activeTabId).classList.add("active"); // Add active class to the selected tab
        }

        // Fetch posts when the page loads
        fetchPosts();
    </script>
</body>
</html>
